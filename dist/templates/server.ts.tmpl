import * as ws from "ws";
import * as schema from "./schema";

const port: number = 23333;

const server = new ws.Server({ port: port });

server.on("connection", (client) => {
    client.on("message", (message) => {
        const request = schema.Request.decode(<Uint8Array>message);
        console.log(`decoded = ${JSON.stringify(request)}`);
{{#apiList}}
        if (request.method == "{{ moduleName }}.{{ apiName }}") {
            const payload = schema.{{ requestType }}.decode(request.payload);
            console.log(`[PWA] Request #${request.sequence}: ${JSON.stringify(payload)}`);
            const handler = require("./api/{{ moduleName }}");
            const responsePayload = schema.{{ responseType }}.create(handler.transformPerson(payload));
            const response = schema.Response.create({sequence: request.sequence, payload: schema.{{ responseType }}.encode(responsePayload).finish()});
            client.send(schema.Response.encode(response).finish());
            console.log(`[PWA] Replied #${request.sequence}: ${JSON.stringify(responsePayload)}`);
        }
{{/apiList}}
    });
});

console.log(`WebSocket server started at port ${port}.`);
